name: ELP CI
on:
  push: {}
  release:
    types: [created]


jobs:
  eqwalizer:
    uses: ./.github/workflows/build-eqwalizer.yml

  eqwalizer-native:
    needs: eqwalizer
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          # - aarch64-unknown-linux-gnu
          # - x86_64-apple-darwin
          # - aarch64-apple-darwin
    uses: ./.github/workflows/build-eqwalizer-native.yml
    with:
      target: ${{ matrix.target }}

  elp:
    needs: eqwalizer-native
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          # - aarch64-unknown-linux-gnu
          # - x86_64-apple-darwin
          # - aarch64-apple-darwin
        otp-version:
          - "26.2"
    uses: ./.github/workflows/build-elp.yml
    with:
      target: ${{ matrix.target }}
      otp-version: ${{ matrix.otp-version }}

  vscode-extension:
    needs: [elp, eqwalizer-native]
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          # - aarch64-unknown-linux-gnu
          # - x86_64-apple-darwin
          # - aarch64-apple-darwin
        otp-version:
          - "26.2"
    uses: ./.github/workflows/build-vscode-extension.yml
    with:
      target: ${{ matrix.target }}
      otp-version: ${{ matrix.otp-version }}

  publish-release-assets:
    needs: [elp, vscode-extension]
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          # - aarch64-unknown-linux-gnu
          # - x86_64-apple-darwin
          # - aarch64-apple-darwin
        otp-version:
          - "26.2"
    uses: ./.github/workflows/publish-release-assets.yml
    with:
      target: ${{ matrix.target }}
      otp-version: ${{ matrix.otp-version }}

  publish-vscode-extension:
    needs: vscode-extension
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          # - aarch64-unknown-linux-gnu
          # - x86_64-apple-darwin
          # - aarch64-apple-darwin
        otp-version:
          - "26.2"
    uses: ./.github/workflows/publish-vscode-extension.yml
    with:
      target: ${{ matrix.target }}
      otp-version: ${{ matrix.otp-version }}
    secrets:
      VSCE_PAT: ${{ secrets.VSCE_PAT }}