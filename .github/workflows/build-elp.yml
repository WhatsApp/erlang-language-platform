on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
      otp-version:
        required: true
        type: string

jobs:
  elp:
    runs-on: ${{ endsWith(inputs.target, 'linux-gnu') && 'ubuntu-latest' || 'macos-latest' }}
    steps:
      - name: Checkout erlang-language-platform
        uses: actions/checkout@v4

      - name: Checkout eqwalizer
        uses: actions/checkout@v4
        with:
          repository: WhatsApp/eqwalizer
          path: eqwalizer

      - name: "Download artifact: eqwalizer.${{ inputs.target }}"
        uses: actions/download-artifact@v4
        with:
          name: eqwalizer.${{ inputs.target }}

      - name: Set up cross-compiler
        if: inputs.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y crossbuild-essential-arm64

      - name: Set up rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          target: ${{ inputs.target }}

      - name: Install Erlang/OTP (Linux Only)
        if: ${{ runner.os == 'Linux' }}
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ inputs.otp-version }}
          install-rebar: false
          install-hex: false

      - name: Install Erlang/OTP (MacOS Only)
        if: ${{ runner.os == 'macOS' }}
        run: |
          otp_version=${{ inputs.otp-version }}
          otp_version_major=${otp_version%%.*}
          brew install erlang@${otp_version_major}
          echo "/usr/local/opt/erlang@${otp_version_major}/bin" >> $GITHUB_PATH

      - name: Verify Erlang/OTP version
        run: |
          erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().' -noshell

      - name: Install rebar3
        run: |
          mkdir rebar3
          curl https://s3.amazonaws.com/rebar3/rebar3 -o rebar3/rebar3
          chmod +x rebar3/rebar3
          echo "$GITHUB_WORKSPACE/rebar3" >> $GITHUB_PATH

      - name: Verify rebar3 version
        run: rebar3 version

      - name: Build elp
        env:
          EQWALIZER_DIR: ${{ github.workspace }}/eqwalizer/eqwalizer
          ELP_EQWALIZER_PATH: ${{ github.workspace }}/eqwalizer.${{ inputs.target }}
        run: |
          cargo build \
            --release  \
            --target ${{ inputs.target }} \
            --config target.aarch64-unknown-linux-gnu.linker=\"aarch64-linux-gnu-gcc\"

      - name: "Prepare elp for uploading"
        run: |
          mv target/${{ inputs.target }}/release/elp target/${{ inputs.target }}/release/elp.otp-${{ inputs.otp-version }}.${{ inputs.target }}

      - name: "Upload artifact: elp.otp-${{ inputs.otp-version }}.${{ inputs.target }}"
        uses: "actions/upload-artifact@v4"
        with:
          name: elp.otp-${{ inputs.otp-version }}.${{ inputs.target }}
          path: target/${{ inputs.target }}/release/elp.otp-${{ inputs.otp-version }}.${{ inputs.target }}